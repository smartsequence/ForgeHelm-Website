---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getLangFromUrl, getAllLanguageCodes, getLocalizedPath } from '../i18n/utils';
import { defaultLang, languages } from '../i18n/languages';

interface Props {
	title: string;
	description?: string;
}

const { title, description } = Astro.props;
// 從 URL 或 params 取得語言（支援動態路由）
const lang = Astro.params?.lang ? (Astro.params.lang as Language) : getLangFromUrl(Astro.url);
const currentPath = Astro.url.pathname;

// 生成所有語言的 hreflang 連結
const allLangs = getAllLanguageCodes();
const hreflangLinks = allLangs.map(l => ({
	lang: l,
	url: new URL(getLocalizedPath(currentPath, l), Astro.site),
}));
---

<!doctype html>
<html lang={lang} data-theme="dark">
	<head>
		<BaseHead title={title} description={description} />
		
		<!-- Canonical URL -->
		<link rel="canonical" href={new URL(currentPath, Astro.site)} />
		
		<!-- hreflang tags for SEO -->
		{hreflangLinks.map(({ lang: l, url }) => (
			<link rel="alternate" hreflang={l} href={url} />
		))}
		<link rel="alternate" hreflang="x-default" href={new URL(getLocalizedPath(currentPath, defaultLang), Astro.site)} />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
		<script is:inline>
			// 自動偵測使用者偏好並應用主題
			(function() {
				const theme = localStorage.getItem('theme') || 'dark';
				document.documentElement.setAttribute('data-theme', theme);
			})();
		</script>
	</head>
	<body>
		<Header lang={lang} currentPath={currentPath} />
		<main>
			<slot />
		</main>
		<Footer lang={lang} />
		<script is:inline>
			// Theme Toggle Function
			window.toggleTheme = function() {
				const html = document.documentElement;
				const currentTheme = html.getAttribute('data-theme');
				const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
				html.setAttribute('data-theme', newTheme);
				localStorage.setItem('theme', newTheme);
			};

			// Auto detect system preference
			window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
				if (!localStorage.getItem('theme')) {
					document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
				}
			});
		</script>
	</body>
</html>

<style is:global>
	:root {
		/* Dark Professional Theme - 與風險報告一致 */
		--bg-main: #0D1A2D;        /* 深色背景主色 */
		--bg-section: #1E293B;     /* 鉛灰藍區塊 */
		--bg-card: #374151;        /* 深灰卡片 */
		--bg-footer: #0F172A;      /* 深藍灰 Footer */
		
		/* Text Colors */
		--text-primary: #FFFFFF;   /* 白色主標題 */
		--text-secondary: #D1D5DB; /* 亮灰說明文字 */
		--text-muted: #9CA3AF;     /* 次要文字 */
		
		/* Interactive Colors */
		--link-color: #3B82F6;     /* Primary Blue */
		--link-hover: #2563EB;     /* 深藍 hover */
		
		/* CTA Colors */
		--cta-primary: #3B82F6;    /* 藍主色 blue-500 */
		--cta-hover: #60A5FA;      /* 較亮藍 blue-400 */
		--cta-success: #10B981;    /* 成功綠 emerald-500 */
		--cta-gold: #F59E0B;       /* 金色徽章 amber-500 */
		--cta-danger: #EF4444;     /* 警示紅 red-500 */

		/* Legacy Aliases - 保持一致 */
		--primary: var(--cta-primary);
		--success: var(--cta-success);
		--error: var(--cta-danger);
		--gray-dark: var(--text-primary);
		--gray-medium: var(--text-secondary);
		--gray-light: var(--text-muted);
		
		/* Border & Divider */
		--border-color: rgba(148, 163, 184, 0.2); /* 半透明邊框 */
		--border-light: rgba(148, 163, 184, 0.1);
		
		/* Shadows - Dark Mode */
		--shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
		--shadow-md: 0 4px 20px rgba(0, 0, 0, 0.4);
		--shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
		
		/* Border Radius */
		--radius-sm: 4px;
		--radius-md: 6px;
		--radius-lg: 8px;
		
		/* Glassmorphism */
		--glass-bg: rgba(55, 65, 81, 0.5);
		--glass-border: rgba(148, 163, 184, 0.2);
	}

	/* Light Theme */
	html[data-theme='light'] {
		--bg-main: #F8FAFC;        /* 淺灰白背景 */
		--bg-section: #FFFFFF;     /* 白色區塊 */
		--bg-card: #FFFFFF;        /* 白色卡片 */
		--bg-footer: #1E293B;      /* Footer 保持深色 */
		
		/* Text Colors */
		--text-primary: #0F172A;   /* 深藍黑標題 */
		--text-secondary: #475569; /* 深灰文字 */
		--text-muted: #64748B;     /* 次要文字 */
		
		/* Interactive Colors */
		--link-color: #3B82F6;     /* 藍色連結 */
		--link-hover: #2563EB;     /* 深藍 hover */
		
		/* CTA Colors - 保持一致 */
		--cta-primary: #3B82F6;
		--cta-hover: #2563EB;
		--cta-success: #10B981;
		--cta-gold: #F59E0B;
		--cta-danger: #EF4444;

		/* Legacy Aliases - 保持一致 */
		--primary: var(--cta-primary);
		--success: var(--cta-success);
		--error: var(--cta-danger);
		--gray-dark: var(--text-primary);
		--gray-medium: var(--text-secondary);
		--gray-light: var(--text-muted);
		
		/* Border & Divider */
		--border-color: rgba(148, 163, 184, 0.25);
		--border-light: rgba(148, 163, 184, 0.15);
		
		/* Shadows - Light Mode */
		--shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
		--shadow-md: 0 4px 20px rgba(0, 0, 0, 0.08);
		--shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
		
		/* Glassmorphism */
		--glass-bg: rgba(255, 255, 255, 0.8);
		--glass-border: rgba(148, 163, 184, 0.2);
	}

	* {
		box-sizing: border-box;
	}

	html {
		font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
		-webkit-font-smoothing: antialiased;
		-moz-osx-font-smoothing: grayscale;
		scroll-behavior: smooth;
	}

	body {
		margin: 0;
		padding: 0;
		padding-top: 80px; /* Fixed header offset */
		min-height: 100vh;
		display: flex;
		flex-direction: column;
		color: var(--text-secondary);
		background: var(--bg-main);
		font-weight: 400;
		letter-spacing: -0.01em;
		transition: background-color 0.3s ease, color 0.3s ease;
	}

	main {
		flex: 1;
	}

	h1, h2, h3, h4, h5, h6 {
		margin: 0;
		font-weight: 700;
		line-height: 1.2;
		letter-spacing: -0.02em;
		color: var(--text-primary);
	}

	h1 {
		font-size: 2.75rem;
		font-weight: 700;
	}

	h2 {
		font-size: 2.25rem;
		font-weight: 700;
	}

	h3 {
		font-size: 1.5rem;
		font-weight: 600;
	}

	p {
		line-height: 1.75;
		margin: 0;
		font-weight: 400;
	}

	a {
		color: var(--link-color);
		text-decoration: none;
		transition: all 0.2s ease;
	}

	a:hover {
		color: var(--link-hover);
	}

	.container {
		max-width: 100%;
		margin: 0 auto;
		padding: 0 2rem;
	}
	
	@media (min-width: 1400px) {
		.container {
			max-width: 100%;
			padding: 0 3rem;
		}
	}

	.section {
		padding: 5rem 0;
	}

	/* Professional Button Styles */
	.btn {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		padding: 0.875rem 2rem;
		border-radius: var(--radius-md);
		font-weight: 600;
		font-size: 0.9375rem;
		transition: all 0.2s ease;
		cursor: pointer;
		border: none;
		text-decoration: none;
		letter-spacing: -0.01em;
	}

	.btn-primary {
		background: var(--cta-primary);
		color: white;
		box-shadow: var(--shadow-sm);
	}

	.btn-primary:hover {
		background: var(--cta-hover);
		box-shadow: var(--shadow-md);
		transform: translateY(-1px);
	}

	.btn-secondary {
		background: transparent;
		color: var(--text-primary);
		border: 2px solid var(--border-color);
	}

	.btn-secondary:hover {
		background: var(--glass-bg);
		border-color: var(--link-color);
		color: var(--link-color);
	}

	@media (max-width: 768px) {
		body {
			padding-top: 70px;
		}

		h1 {
			font-size: 2rem;
		}

		h2 {
			font-size: 1.75rem;
		}

		h3 {
			font-size: 1.25rem;
		}

		.section {
			padding: 3rem 0;
		}
	}
</style>
